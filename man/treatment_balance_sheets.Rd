% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/treatment_balance_sheets.R
\name{treatment_balance_sheets}
\alias{treatment_balance_sheets}
\title{Process and reshape "balancetes" CSV exports from the Brazilian Central Bank (BCB)}
\usage{
treatment_balance_sheets(
  path_raw = "data_raw",
  out_dir = "data",
  doc_filter = 4010,
  save = TRUE,
  output_filename = NULL
)
}
\arguments{
\item{path_raw}{Character scalar. Directory containing the raw CSV files.
Filenames are expected to start with a YYYYMM prefix (e.g. "202012COOPERATIVAS.CSV").
The function will look for files matching "\\.CSV$" (case-insensitive).}

\item{out_dir}{Character scalar. Directory where output CSVs will be saved
when \code{save = TRUE}. If it does not exist it will be created.}

\item{doc_filter}{Numeric or integer scalar. The numeric value used to
filter rows in the imported tables by the column DOCUMENTO (e.g. 4010).
Other options are: 4010, 4413, 4423, 4433, 4060, 4016 and 4066.
Check the webpage for more details: https://www.bcb.gov.br/estabilidadefinanceira/balancetesbalancospatrimoniais}

\item{save}{Logical scalar. If \code{TRUE} (default) the processed data
frames are written to disk as CSV files (one per institution type).}

\item{output_filename}{NULL, character scalar, or function. Controls the
output file path(s) used when \code{save = TRUE}:
\itemize{
\item NULL (default): a function is created that writes files to
\code{file.path(out_dir, paste0(doc_filter, "_", tolower(type_inst), ".csv"))}.
\item a single string: that filename (inside \code{out_dir}) is used for all types.
\item a function: should accept a single argument \code{type_inst} and return a filename;
the returned path will be wrapped with \code{out_dir}.
}}
}
\value{
A named list of data.frames (one element per unique institution
type detected in the filenames). Each data.frame has one row per
unique combination of (data_base, documento, cnpj, nome_instituicao)
and one column per account (the "conta" values) with balances
populated from the "saldo" column.
}
\description{
\ifelse{html}{\href{https://lifecycle.r-lib.org/articles/stages.html#superseded}{\figure{lifecycle-superseded.svg}{options: alt='[Superseded]'}}}{\strong{[Superseded]}}

\code{treatment_balance_sheets} reads raw CSV export files produced by the BCB,
normalizes filenames, locates the header row, imports rows matching a
specific document number, cleans column names, pivots account balances
so that each account becomes a column and each row corresponds to an
institution/date, and optionally writes per-institution-type CSVs.
}
\details{
Behavior and implementation notes:
\itemize{
\item Filenames are first normalized by removing all underscores. If a
target filename after normalization already exists, the function
aborts to avoid overwriting files.
\item The function extracts year/month and an institution type token from
the file basename by assuming the first six characters are YYYYMM
and the remaining characters (without the ".CSV") represent the type.
\item For each file the function reads the file as text and attempts to
locate the header row by scanning lines until it finds a row that
contains (case-insensitive) tokens matching:
\itemize{
\item "DOCUMENTO" (or "DOCUMENTOS"),
\item "CNPJ",
\item and "DATA BASE" (variants matched by regex such as "DATA_BASE" or "#DATA_BASE").
The delimiter for that header line is heuristically detected among
semicolon (";"), comma (","), or whitespace. For whitespace-delimited
data the function uses read.table's default behavior.
}
\item After locating the header, the table is read with \code{utils::read.table}
using \code{header = TRUE}, the detected separator, latin1 encoding,
and \code{check.names = FALSE}. Rows where the DOCUMENTO column equals
\code{doc_filter} are kept.
\item Column names are cleaned via \code{janitor::clean_names()} before
the wide pivot. The function expects at least the following cleaned
column names to be present: \code{conta}, \code{saldo}, and
\code{number_data_base}. The pivot uses the id columns
(\code{number_data_base}, \code{documento}, \code{cnpj},
\code{nome_instituicao}), \code{conta} as names and \code{saldo} as values.
\item If \code{save = TRUE} each resulting data.frame is written to CSV
using \code{readr::write_csv()} to the path returned by
\code{output_filename(type_inst)} (wrapped with \code{out_dir}).
\item The function will stop with informative errors in several situations:
missing CSVs in \code{path_raw}, failure to find a header line with
the required tokens, missing required columns after import/cleaning,
or failure to rename files when removing underscores.
}
}
\note{
The function prints a message reminding that the numeric values
in the balancetes are not adjusted for inflation. See:
https://www.bcb.gov.br/estabilidadefinanceira/balancetesbalancospatrimoniais
}
\examples{
\dontrun{
# Basic usage (do not write outputs)
treatment_balance_sheets(path_raw = "data_raw", out_dir = "data", doc_filter = 4010, save = FALSE)

# Write outputs with a fixed filename for all types
treatment_balance_sheets(path_raw = "data_raw", out_dir = "data", doc_filter = 4010,
                      save = TRUE, output_filename = "bc_balance_sheets.csv")

# Custom naming function
treatment_balance_sheets(path_raw = "data_raw", out_dir = "out",
                      doc_filter = 4010, save = TRUE,
                      output_filename = function(type) paste0("bal_", tolower(type), ".csv"))
}

}
